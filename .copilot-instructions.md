# McBopomofo Copilot Instructions

## What's the Project For

McBopomofo (小麥注音輸入法) is a Traditional Chinese input method engine (IME) for macOS. It allows users to input Traditional Chinese characters using the Bopomofo phonetic system (注音符號), which is the standard phonetic notation system used in Taiwan. 

The project is part of the OpenVanilla framework and provides:
- Smart phonetic-to-character conversion
- User-customizable phrase dictionaries
- Associated phrase suggestions
- Multi-candidate selection
- Support for custom user phrases and exclusions

## System Requirements

### Runtime Requirements
- macOS 10.15 (Catalina) or later

### Development Requirements
- macOS 14.7 or later
- Xcode 15.3 or later
- Python 3.9 (available through Xcode or homebrew)

## Build Process

The project uses Xcode as its primary build system:

1. **Open Project**: Open `McBopomofo.xcodeproj` in Xcode
2. **Select Target**: Choose "McBopomofoInstaller" target
3. **Build**: Build the project (⌘+B)
4. **Install**: Run the installer directly to install McBopomofo
5. **Reinstall**: For subsequent updates, repeat the process

### Important Notes
- macOS may limit the number of times an input method process can be killed in a single login session
- If installation issues occur after multiple installs, log out and log back in
- The installer automatically kills and restarts the input method process

## Project Components

### Architecture Overview
```
McBopomofo/
├── Source/                     # Main application source
│   ├── Engine/                # C++ core engine
│   │   ├── Mandarin/         # Bopomofo processing
│   │   ├── gramambular2/     # Text segmentation library
│   │   └── McBopomofoLM.*    # Language model
│   ├── InputState.swift       # State machine implementation
│   ├── InputMethodController.swift  # Main controller
│   └── Data/                 # Language model data files
├── McBopomofoTests/           # Test suite
└── Packages/                  # Swift Package dependencies
```

### Technology Stack
- **Swift**: UI layer, input method controller, state management
- **Objective-C++**: Bridge between Swift and C++ components
- **C++**: Core engine, language processing, data structures
- **Xcode**: Build system and development environment

### Key Files
- `InputMethodController.swift`: Main input method logic
- `InputState.swift`: State machine implementation
- `Source/Engine/McBopomofoLM.h/cpp`: Language model management
- `Source/Engine/Mandarin/Mandarin.h/cpp`: Bopomofo processing
- `Source/Engine/gramambular2/`: Text segmentation algorithms

## Design of Input States

McBopomofo implements a finite state machine with multiple distinct states to handle various input scenarios:

### Core Input States

1. **Deactivated**: User hasn't activated McBopomofo
2. **Empty**: McBopomofo is active but no input yet, or user just committed text
3. **Inputting**: User is typing Bopomofo keys; input buffer is visible
4. **Committing**: Sending text to client applications
5. **Marking**: User is selecting text in buffer to create custom phrase
6. **ChoosingCandidate**: Candidate window is open for user selection

### Extended States

The system includes additional specialized states:

- **SelectingFeature**: User accessing special features menu
- **SelectingDateMacro**: Date/time macro selection
- **ChineseNumber**: Chinese numeral conversion
- **Big5**: Big5 encoding conversion
- **EnclosedNumber**: Circled/parenthesized number conversion
- **AssociatedPhrases**: Associated phrase suggestions
- **SelectingDictionary**: Dictionary lookup mode
- **ShowingCharInfo**: Character information display
- **CustomMenu**: Custom menu operations

### State Properties
- **Immutable**: States are immutable objects; transitions create new state instances
- **One-way data flow**: UI and text output follow single data source
- **Context-specific data**: Each state contains only relevant data (e.g., candidate list only exists in Choosing Candidate state)

### Implementation Details
- Base class: `InputState`
- State-specific subclasses: `Deactivated`, `Empty`, `Inputting`, `Committing`, `Marking`, `ChoosingCandidate`
- Controller creates new state objects instead of modifying existing ones

## Design of Mandarin Package

The Mandarin package handles Bopomofo phonetic input processing and conversion.

### Core Classes

#### BopomofoSyllable (BPMF)
- **Purpose**: Represents a complete Bopomofo syllable
- **Storage**: 16-bit integer with bit masks for components
- **Components**: Consonant, Middle Vowel, Vowel, Tone Marker
- **Features**:
  - Conversion to/from Hanyu Pinyin
  - Composed string representation
  - Component validation and extraction
  - Overlap detection between syllables

#### BopomofoKeyboardLayout
- **Purpose**: Maps keyboard keys to Bopomofo components
- **Key Functions**:
  - `syllableFromKeySequence()`: Converts key sequence to syllable
  - `keySequenceFromSyllable()`: Converts syllable back to keys
- **Layout Support**: Different keyboard layouts for Bopomofo input
- **Validation**: Ensures valid key combinations (e.g., J/Q/X require I or UE vowels)

#### BopomofoReadingBuffer
- **Purpose**: Manages user input during syllable composition
- **Features**:
  - Key combination and validation
  - Pinyin mode support
  - Buffer clearing and state management
  - Integration with keyboard layouts

### Key Algorithms

#### Syllable Construction
1. Process each key in input sequence
2. Check for valid key combinations
3. Handle special cases (J/Q/X with I/UE vowels)
4. Apply tone markers correctly
5. Validate final syllable composition

#### Component Mapping
- Bit-masked representation for efficient storage
- Separate masks for consonants, vowels, and tones
- Support for multiple components per key

## Design of Language Model (McBopomofoLM)

The language model manages text conversion, user customization, and phrase suggestions.

### Architecture

#### McBopomofoLM Class
- **Inheritance**: Extends `Formosa::Gramambular2::LanguageModel`
- **Purpose**: Central hub for all language processing
- **Integration**: Combines multiple data sources and processing layers

### Data Processing Pipeline

When processing unigrams (single-character/phrase entries):

1. **Original Unigrams**: Retrieve from primary language model
2. **Exclusion Filtering**: Remove user-excluded phrases
3. **Phrase Replacement**: Apply user-defined replacements
4. **External Conversion**: Transform via external converter (if enabled)
5. **Deduplication**: Remove duplicate entries
6. **Return Results**: Provide final candidate list

### Key Components

#### Primary Language Model
- **ParselessLM**: Main language model for character/phrase data
- **Unigram-based**: Uses single-token probability model
- **File-based**: Loads from bundled data files

#### User Customization
- **UserPhrasesLM**: User-defined custom phrases
- **Exclusion List**: User-blocked phrases
- **Replacement Map**: User-defined phrase substitutions
- **Associated Phrases**: Context-based phrase suggestions

#### External Processing
- **Macro Converter**: Handles text macros and shortcuts
- **External Converter**: Pluggable text transformation
- **Runtime Configuration**: Enable/disable features dynamically

### File Management
- **User Data Folder**: Configurable location for user files
- **Template System**: Automatic creation of empty user files
- **Atomic Updates**: Safe file writing and reloading

## Algorithm of Gramambular2

Gramambular2 is the core segmentation and input method library using statistical models.

### Theoretical Foundation

#### Hidden Markov Model (HMM)
- **Observations**: Input characters or Bopomofo syllables
- **Hidden States**: Possible character/phrase groupings
- **Goal**: Find most likely segmentation given input sequence

#### Naive Bayes Classification
- **Approach**: Simplified probabilistic classification
- **Assumptions**: Independence between features
- **Efficiency**: Fast computation suitable for real-time input

### Core Algorithm

#### Segmentation Process
1. **Input Sequence**: Receive series of observations (syllables/characters)
2. **State Generation**: Generate possible hidden states (character combinations)
3. **Probability Calculation**: Compute likelihood using unigram model
4. **Path Selection**: Choose most probable segmentation path
5. **Output Generation**: Return most likely character sequence

#### Language Model Integration
- **Unigram Model**: Simple single-token probability model
- **Frequency-based**: Probabilities derived from corpus frequency
- **Extensible**: Support for custom language models

### Implementation Details

#### Reading Grid
- **Purpose**: Manages candidate generation and selection
- **Structure**: Grid of possible readings and conversions
- **Optimization**: Efficient storage and retrieval of candidates

#### Language Model Interface
- **Abstract Base**: `LanguageModel` interface for pluggable models
- **Standard Methods**: `hasUnigrams()`, `getUnigrams()` for data access
- **Extensibility**: Support for custom language model implementations

### Performance Characteristics
- **Real-time**: Optimized for interactive input method use
- **Memory Efficient**: Minimal memory footprint
- **Scalable**: Handles large dictionaries efficiently
- **Fast Lookup**: Quick candidate generation and ranking

### Use Cases
1. **Input Method**: Convert Bopomofo sequences to Chinese characters
2. **Text Segmentation**: Break Chinese text into meaningful units
3. **Candidate Ranking**: Order possible conversions by probability
4. **Context Awareness**: Consider surrounding text for better suggestions

## Development Guidelines

### Code Organization
- **Swift**: Use for UI, state management, and application logic
- **C++**: Use for performance-critical algorithms and data processing
- **Objective-C++**: Use for bridging between Swift and C++

### Testing
- **Unit Tests**: Located in `McBopomofoTests/`
- **Integration Tests**: Test complete input workflows
- **Language Model Tests**: Validate dictionary and processing logic

### Debugging
- **State Inspection**: Monitor InputState transitions
- **Language Model**: Verify unigram processing pipeline
- **Syllable Processing**: Check Bopomofo key handling

### Performance Considerations
- **Memory Management**: Careful handling of large language model data
- **Real-time Constraints**: Input method must be responsive
- **Battery Usage**: Optimize for minimal system impact